<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE muclient>

<!-- Plugin "Health_Bar" generated by Plugin Wizard -->

<muclient>
<plugin
   name="SK_TickBar"
   author="Aello"
   id="7e2bf8628a8f51bf2115d2f0"
   language="Lua"
   purpose="Show RegenTick, HP, ME, PE"
   date_written="2009-02-08"
   requires="4.35"
   version="1.1"
   >
<description trim="y">
<![CDATA[
Regen tick with hp, mana, and pe bar
]]>
</description>
</plugin>

<aliases>
	<alias
		match="^hc$"
		enabled="y"
		regexp="y"
		send_to="12"
		sequence="100"
	>
		<send>
			SetVariable("HP", 20)
			SetVariable("ME", 20)
			SetVariable("PE", 20)
			draw_bar ()
		</send>
	</alias>
	<alias
		match="^tc$"
		enabled="y"
		regexp="y"
		send_to="12"
		sequence="100"
	>
		<send>
			SetVariable("tickTime", 0)
			draw_bar ()
		</send>
	</alias>
</aliases>
<script>
<![CDATA[
	win = GetPluginID ()  -- get a unique name
	GAUGE_HEIGHT = 15
	HP_HEIGHT = 12
	BAR_WIDTH = 645
	NUMBER_OF_TICKS = 4
	BACKGROUND_COLOUR = ColourNameToRGB "gray"
	BOX_COLOUR = ColourNameToRGB "dodgerblue"
	HP_COLOUR = ColourNameToRGB "green"
	ME_COLOUR = ColourNameToRGB "blue"
	PE_COLOUR = ColourNameToRGB "yellow"
	maxHP = 100
	maxTime = 61

	function draw_bar ()
		currentTime = tonumber(GetVariable("tickTime")) or 0
		currentHP = tonumber(GetVariable("HP")) or 100
		currentME = tonumber(GetVariable("ME")) or 100
		currentPE = tonumber(GetVariable("PE")) or 100

		if currentHP < 30 then
			HP_COLOUR = ColourNameToRGB "red"
		elseif currentHP < 60 then
			HP_COLOUR = ColourNameToRGB "orange"
		elseif currentHP < 80 then 
			HP_COLOUR = ColourNameToRGB "lime"
		else
			HP_COLOUR = ColourNameToRGB "green"
		end

		-- width is window width minus 2
		local gauge_width = BAR_WIDTH

		-- make room for the bar
		local bottom_margin = GetInfo (275)

		-- adjust text rectangle, keeping existing settings where possible
		if bottom_margin == 0 or 
				(bottom_margin < 0 and math.abs (bottom_margin) < (GAUGE_HEIGHT + HP_HEIGHT + 2)) then
			TextRectangle(GetInfo (272), GetInfo (273),   -- left, top
				GetInfo (274), -- right
				- (GAUGE_HEIGHT + HP_HEIGHT + 2),  -- bottom (gauge height plus 2 more)
				GetInfo (276), GetInfo (282) or 0, GetInfo (277),  --  BorderOffset, BorderColour, BorderWidth
				GetInfo (278), GetInfo (279)) -- OutsideFillColour, OutsideFillStyle

	end -- if
  
	-- make the miniwindow
	WindowCreate (win, 
		0, 0,   -- left, top (auto-positions)
		BAR_WIDTH,     -- width
		GAUGE_HEIGHT + HP_HEIGHT,  -- height
		10,       -- auto-position: bottom left
		0,  -- flags
		BACKGROUND_COLOUR) 

	WindowRectOp (win, 2, 0, 0, 0, 0, BACKGROUND_COLOUR)  -- fill entire box

	-- how far through the level we are 
	local done = currentTime / maxTime
	local bar_width = gauge_width * done
	local doneHP = currentHP / maxHP
	local doneME = currentME / maxHP
	local donePE = currentPE / maxHP
	local bar_widthHP = gauge_width * doneHP
	local bar_widthME = gauge_width * doneME
	local bar_widthPE = gauge_width * donePE


	if math.floor (bar_width) > 0 then
		-- top half
		WindowGradient (win, 0, 0, 
			bar_width, GAUGE_HEIGHT / 2, 
			0x000000,  -- black
			BOX_COLOUR, 
			2)   -- vertical gradient

		-- bottom half
		WindowGradient (win, 0, GAUGE_HEIGHT / 2, 
			bar_width, GAUGE_HEIGHT, 
			BOX_COLOUR,
			0x000000,  -- black
			2)   -- vertical gradient
	end

	if currentHP > 0 then
		WindowGradient (win, 0, GAUGE_HEIGHT, 
			bar_widthHP, GAUGE_HEIGHT + HP_HEIGHT / 3, 
			HP_COLOUR,  -- black
			HP_COLOUR, 
			2)   -- vertical gradient
	end

	-- bottom half
	if currentME > 0 then
		WindowGradient (win, 0, GAUGE_HEIGHT + HP_HEIGHT / 3, 
			bar_widthME, GAUGE_HEIGHT + ((HP_HEIGHT/3) * 2) , 
			ME_COLOUR,
			ME_COLOUR,  -- black
			2)   -- vertical gradient
	end
					
	if currentPE > 0 then
		WindowGradient (win, 0, GAUGE_HEIGHT + ((HP_HEIGHT/3) * 2), 
			bar_widthPE, GAUGE_HEIGHT + HP_HEIGHT, 
			PE_COLOUR,
			PE_COLOUR,  -- black
			2)   -- vertical gradient
	end

	-- show ticks
	local ticks_at = gauge_width / NUMBER_OF_TICKS

	-- ticks
	for i = 1, NUMBER_OF_TICKS do
		WindowLine (win, i * ticks_at, 0, i * ticks_at, GAUGE_HEIGHT + HP_HEIGHT, ColourNameToRGB ("silver"), 0, 1)
	end -- for

	-- draw a box around it
	check (WindowRectOp (win, 1, 0, 0, 0, 0, ColourNameToRGB ("lightgrey")))  -- frame entire box

	WindowFont (win, "tickFont", "Trebuchet MS", 7, true, false, false, false)
	WindowText (win, "tickFont", "Tick Tock Timer: " .. currentTime,
			5, 0, 0, 0,  -- rectangle
			ColourNameToRGB ("white"), 
			false)
	WindowShow (win, true)
end

function OnPluginWorldOutputResized ()
	draw_bar ()
end
 
function OnPluginClose ()
	WindowShow (win,  false)  -- hide it
end

function OnPluginDisable ()
	WindowShow (win,  false)  -- hide it
end
]]>

</script>

<timers>
	<timer 
		name="tickTime" 
		enabled="y" 
		minute="0" 
		second="1" 
		offset_second="0"    
		send_to="12"
		group="tickTime" 
	>
		<send>
			tickTime = GetVariable("tickTime") or 0
			tickTime = (tickTime + 1) % 61
			SetVariable("tickTime", tickTime)
			draw_bar ()
		</send>
	</timer>
</timers>

<triggers>
	<trigger
		enabled="y"
		group="Tick"
		match="^(A magical gate vanishes into thin air\.|The city stirs to shake off the night as a new day begins\.|The comforts of the inn put you at ease\.|You feel an effervescent energy dissipate into your dreams\.|You are hungry\.|You are thirsty\.|Your pulse slows to normal\.|Death arrives and escorts your soul to the spirit world\.|The Teronian Temple bell strikes six times, ringing loudly through the streets\.|The mystic portal vanishes into thin air\.|A bracer made of mithril scales on (.*)'s wrist shimmers slightly\.|The city stirs to shake off the night as a new day begins\.|A corpse of (.*) decays into dust\.|The deathly silence is broken by a muffled whistle of arctic air\.   |The (.*) crumbles into dust\.|The plants recede back into the ground\.|It's breezy\.|A slight wind blows a chill into living tissue\.|(.*) regains consciousness and rises unsteadily to (.*) feet\.|The shuffling of feet can be heard in the distance\.|Drip\.\.\.Drip\.\.\.Drip\.\.\.|The city slows, drawing in on itself as dusk gathers and another day ends\.|In the distance, Peacekeepers call the changing of the guard\.|It's hot out here\.|A ruddy pebble on a chain worn by (.*) glows red momentarily\.|The stones glow eerily\.\.\.|A glowing portal snaps into existence in the midst of the stones!|The clinking of metal on stone resounds through the caves\.|An aura of divine blessing surrounds (.*)\.|Touched by a light breeze, the clouds rearrange themselves\.   |The ether wire phases partially out of existence\. |You are ready to summon another treant\.|The white aura around your body fades\.|Your symbol slowly begins to melt and reform!|You hear a distant rumble as stone shifts somewhere deep below you\.)$"
		regexp="y"
		send_to="12"
		sequence="100"
	>
		<send>
			SetVariable("tickTime", 0)
			draw_bar ()
			--Note("Tick?")
		</send>
	</trigger>
	<trigger
		enabled="y"
		group="Tick"
		match="^(A lightly falling snow is being driven by a strong wind\.|It's raining lightly\.|It's nice and warm out\.|The snow is coming down faster now\.|It's cool out here\.|Drifts in the snow are being formed by the wind\.|A freezing wind blows gently, but firmly against all obstacles in the area\.|A light snow is falling amidst an unsettled wind\.|A light drizzle is falling here\.|It rains a bit harder\.|The rain stops\.|A cool breeze wafts by\.|The rain is falling less heavily now\.|The rain turns to snow\.|The snow has let up a little\.|The snow turns to a cold rain\.|The wind and a bit of rain hint at the possibility of a storm\.|The wind isn't very strong here, but the cold makes it quite noticeable\.|It stops snowing\.|It's cold!|It's mild out today\.|The breeze dies away to nothing\.|The wind begins to blow from the [a-zA-Z]+\.|The wind changes and begins blowing from the [a-zA-Z]+\.|The sun slowly disappears in the [a-zA-Z]+\.|It's hotter than anyone could imagine\.|A blast of freezing wind chills you to the bone\.   |It's really c-c-c-cold!!|Better get inside - this is too cold for man or -most- beasts\.|It's a bit nippy here\.|A warm pocket of air is rolling through here\.|It's really, really hot here\.  A slight breeze would really improve things\.|The breeze dies away to nothing\.|There's a blizzard out here, making it quite difficult to see\.|The snow turns to a cold rain\.|A light drizzle is falling here\.|The arid wind brings no relief\.   |A few drops of rain are falling amidst a fierce windstorm\.)$"
		regexp="y"
		send_to="12"
		sequence="100"
	>
		<send>
			currentTime = GetVariable("tickTime") or 0
			if tonumber(currentTime) >= 55 or tonumber(currentTime) &lt;= 5 then
				SetVariable("tickTime", 0)
				draw_bar()
				--Note("Tick?")
			end
		</send>
	</trigger>
	<trigger
		enabled="y"
		group="Tick"
		match="^\[HP\:([0-9\s]+)\%\] \[ME\:([0-9\s]+)\%\] \[PE\:([0-9\s]+)\%\].*"
		regexp="y"
		send_to="12"
		sequence="100"
	>
		<send>
			HP = "%1"
			ME = "%2"
			PE = "%3"
			SetVariable("HP", HP)
			SetVariable("ME", ME)
			SetVariable("PE", PE)
			draw_bar ()
		</send>
	</trigger>
</triggers>

</muclient>